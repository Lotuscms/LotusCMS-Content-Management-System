<?php
include_once("core/lib/Observable.php");

class Controller extends Observable{
	
	//Class View
	protected $cv;
	
	//Class Model
	protected $cm;
	
	//The user variable
	protected $user;
	
	//The page setting system
	protected $p;
	
	//Request
	protected $request;
	
	//Array of the reqs
	protected $req;
	
	//Controller ID
	protected $id;
	
	//System Name
	protected $system;
	
	//Wildcard
	protected $wildCard;
	
	/**
	 * Get the paging system
	 */
	public function getPaging(){
		return $this->p;	
	}
	
	/**
	 * Get the paging system
	 */
	public function setPaging($page){
		$this->p = $page;	
	}
	
	/**
	 * Set the system
	 */
	public function setSystem($sys){
		$sys = str_replace(";","",$sys);
		$this->system = htmlentities ( trim ($sys));	
	}
	
	/**
	 * set the system
	 */
	public function getSystem(){
		return $this->system;	
	}
	
	/**
	 * Setup the required page
	 * Kevin Bluett July 2011
	 * @param $system 		=> Name of the Controller eg. DashController must be inputted as "Dash" 
	 * @param $title 		=> Title of the page to be setup
	 * @param $template 		=> The template to be loaded by the paging systems. Defaults to "admin"
	 * @param $auth			=> The user level required to access page. Leave blank for no login, '*' for any user a/c, 'user_group' for a specific user group
	 */
	public function setup($system, $title, $template = "admin", $auth = "*"){
		
		//Setup basic variables
		$this->varSetup();
		
		//Sets the name of the other classes
		$this->setSystem($system);

		//Setup Classes
		$this->setupClasses();
		
		//Setup paging system
		$this->setupPaging();
		
		//Setup as array
		$this->req = array();
		
		//Set title of the Dashbaord.
		$this->p->setContentTitle($title);
		
		//Set to two columns
		$this->p->setTwoColumn();
		
		//Set to Administration template
		$this->getView()->setTemplate($template);
		
		//Check for Plugins
		$this->loadPlugins();
		
		//Set the requests accepted
		$this->putRequests();
		
		if(!empty($auth)){
			//Load the requirement for all pages to be password protected by user management
			$this->requireAuth();
		}
		
		//Process Request
		$this->processRequest();
		
		$this->displayPage();
	}
	
	/**
	 *	Setup the required classes
	 */
	protected function setupClasses(){
		
		//Get class names
		$className = $this->getSystem();
		
		//View
		include("core/view/".$className."View.php");
		
		//Model
		include("core/model/".$className."Model.php");
		
		$load = $className."View";
		
		//Setup the classview
		$this->cv = new $load();
		
		//Set this as controller
		$this->cv->setController($this);
		
		//Set View
		$this->cv->setView($this->cv);
		
		$load = $className."Model";
		
		//Setup the classmodel
		$this->cm = new $load();
		
		//Set this as controller
		$this->cm->setController($this);
		
	}
	
	/**
	 * Setup the paging system if required
	 */
	protected function setupPaging(){
		//Setup the required page
		$this->cv->setupPage();	
		
		$this->setPaging($this->cv);
	}
	
	
	/**
	 * Set the requests
	 */
	public function setRequests($requests){
		
		$this->wildCard = false;
		
		//Set the requests
		$this->req = $requests;
	}
	
	/**
	 * Allow Wildcard Request
	 */
	public function setWildCardMode($req){
		
		//Set the wildcard request setting.
		$this->wildCard = $req;
		
	}
	
	/**
	 * Add Request
	 */
	public function addRequest($request){
		
		//Add Array Push
		$this->req = array_push($this->req, $request);
		
	}
	
	/**
	 * Empty All request
	 */
	public function emptyRequests(){
		//Empty Array
		$this->req = array();
	}
		
	/**
	 * Display the required page that was setup
	 */	
	public function displayPage(){
		if(isset($this->p))
		{
			$this->p->displayPage();	
		}	
	}
		
	/**
	 * Process the page request
	 */
	public function processRequest(){

		$found = false;
		
		$localRequest = (String)$this->request;
		
		//Set the Locale
		$this->getModel()->setLocale();
		
		//If in wildcard mode process as wildcard override.
		if($this->wildCard){
			
			//Run Wildcard
			$this->wildCardRequest();
			
			//Break from this function
			return false;
		}
		
		//Requests the default system
		if(empty($localRequest))
		{
			$this->defaultRequest();
		}
		
		//Process the request
		if(in_array($localRequest, $this->req))
		{
			$load = $localRequest."Request";
			
			$this->$load();
			
			$found = true;
		}
		
		//Page not found
		if(!$found)
		{
			//Get the 404 page
			$this->cv->noPage();
		}
	}
	
	/**
	 * ID
	 */
	public function getID(){
		return $this->id;	
	}	
	
	/**
	 * Page Request
	 */
	public function setPageRequest($req){
		$this->request = $req;	
	}

	
	/**
	 * ID
	 */
	public function setID($id){
		$this->id = $id;	
	}
	
	/**
	 * Get Model
	 */
	public function getModel(){
		//Returns model
		return $this->cm;
	}
	
	/**
	 * Get View
	 */
	public function getView(){
		//Returns model
		return $this->cv;
	}
	
	
	/**
	 * Exit the system
	 */
	public function freeze_all(){
		exit;	
	}
	
	/**
	 * Returns a global variable
	 */
	protected function getInputString($name, $default_value = "", $format = "GPCS")
    {

        //order of retrieve default GPCS (get, post, cookie, session);

        $format_defines = array (
        'G'=>'_GET',
        'P'=>'_POST',
        'C'=>'_COOKIE',
        'S'=>'_SESSION',
        'R'=>'_REQUEST',
        'F'=>'_FILES',
        );
        preg_match_all("/[G|P|C|S|R|F]/", $format, $matches); //splitting to globals order
        foreach ($matches[0] as $k=>$glb)
        {
            if ( isset ($GLOBALS[$format_defines[$glb]][$name]))
            {   
                return $GLOBALS[$format_defines[$glb]][$name];
            }
        }
      
        return $default_value;
    } 
    
    /**
     * Sets up the basic variables
     */
    protected function varSetup(){
  		//Allow Plugins.
		Observable::Observable();
    	
    	//Setup ID
		$this->setID($this->getInputString("id", -1, "G"));
		
		//Set Page request
		$this->setPageRequest($this->getInputString("page", "", "G")); 
    }
    
    /**
     * Dumps a variable for better viewing and exits;
     */
    public function error_dump($var){
    	
    	//Print variable in preformatted method
    	print "<pre>";
    	
    	//Dump Variable Out
		var_dump($var);
		
		//Print End of the preformatted section
		print "</pre>";
		
		//Stop Everything
		$this->freeze_all();	
    }
    
    /**
     * Returns the directory containing all the pages.
     */
    public function getPageDirectory(){
    	return "data/pages";	
    }
    
    /** 
     * Gets the version running this CMS.
     */
    public function getVersion(){
    	return $this->getModel()->openFile("data/config/site_version.dat");
    }
    
    /**
     * Restricted access to the pages via defined usergroup.
     */
    protected function requireAuth($user = "*"){
    	
		// Set the state and tell plugins.
		$this->setState('REQUIRE_AUTH');
		$this->notifyObservers();
    	
    	if($user=="*"){
			if(!$this->getModel()->checkLogin(true)){
				//Login status check failed.
				$this->freeze_all();
			}
    	}else{
			if(!$this->getModel()->checkLogin(true)){
				//Login status check failed.
				$this->freeze_all();
			}else{
				//Success, but now be need to check usertype.
				if(!$this->checkUserLevel($user)){
					//Get Access Denied Page for his level
					$cont = $this->openFile("core/fragments/users/access_denied.phtml");
				
					//Set the content
					$this->getController()->getView()->setContentTitle("Access Denied");
					
					//Set the content
					$this->getController()->getView()->setContent($cont);
					
					//Display page
					$this->getController()->displayPage();
					
					//Stop All Processing
					$this->getController()->freeze_all();
				}
			}
    	}
    }
    
   	/**
	 * Requires logged in user to be administrator
	 */
	public function requireAdministrator(){
		
		// Set the state and tell plugins.
		$this->setState('REQUIRE_ADMINISTRATOR');
		$this->notifyObservers();
		
		$this->requireAuth("administrator");
	}
    
   	/**
	 * Checks the user access level
	 */
	protected function checkUserLevel($lvl){
		
		// Set the state and tell plugins.
		$this->setState('CHECKING_USER_LVL');
		$this->notifyObservers();
		
		//Get Access level (Force userage of Session variable - otherwise attack is possible)
		$access = $this->getInputString("access_lvl", "", "S");
			
		//Check Access Level
		if($lvl!=$access)
		{
			//The User does not have the rights to access this area
			return false;	
		}
		//Access Level OK
		else
		{
			//Access OK
			return true;	
		}
	}
    
    /**
     * Loads any plugins for for use in observation system.
     */ 
    public function loadPlugins(){
	
		//Get the system.
		$system = $this->getSystem();
		
		//Only Load plugins if the loading file exists.
		if(file_exists("data/config/modules/".$system.".dat")){
			//Get Plugin Loading File
			$plugs = $this->getModel()->openFile("data/config/modules/".$system.".dat");
			
			//Get containing plugs
			$plugs = explode("|", $plugs);
			
			//Load Each individual plugs
			for($i = 0; $i < count($plugs); $i++){
				
				//Include the plugin
				include_once("core/lib/Observer.php");
				
				if(file_exists("modules/".$plugs[$i]."/".$system."ControllerPlugin.php")){
					include_once("modules/".$plugs[$i]."/".$system."ControllerPlugin.php");
					
					$c = $plugs[$i]."Controller";
					$c = new $c;
					
					$c->setupObserver($this);
				}
				
				if(file_exists("modules/".$plugs[$i]."/".$system."ModelPlugin.php")){
					include_once("modules/".$plugs[$i]."/".$system."ModelPlugin.php");
					
					$c = $plugs[$i]."Model";
					$c = new $c;
					
					$c->setupObserver($this->getModel());
				}
				
				if(file_exists("modules/".$plugs[$i]."/".$system."ViewPlugin.php")){
					include_once("modules/".$plugs[$i]."/".$system."ViewPlugin.php");
					
					$c = $plugs[$i]."View";
					$c = new $c;
					
					$c->setupObserver($this->getView());
				}
			}
		}
    }
}

?>